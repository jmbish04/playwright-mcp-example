<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Session Monitor · Playwright MCP</title>
  <style>
    body {
      margin: 0;
      font-family: 'Inter', system-ui, sans-serif;
      background: linear-gradient(180deg, #020617 0%, #111827 40%, #0b1120 100%);
      color: #e2e8f0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      padding: 2.4rem 1.5rem 1.2rem;
      text-align: center;
    }

    header h1 {
      margin: 0;
      font-size: clamp(2rem, 4vw, 3rem);
      letter-spacing: 0.02em;
    }

    header p {
      margin: 0.9rem auto 0;
      max-width: 760px;
      line-height: 1.6;
      color: rgba(226, 232, 240, 0.8);
    }

    main {
      flex: 1;
      padding: 0 1.5rem 4rem;
      max-width: 1200px;
      margin: 0 auto;
      width: 100%;
      display: grid;
      grid-template-columns: minmax(0, 1fr) minmax(0, 420px);
      gap: 1.8rem;
    }

    @media (max-width: 1100px) {
      main {
        grid-template-columns: 1fr;
      }
    }

    a.back-link {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      color: rgba(148, 163, 184, 0.9);
      text-decoration: none;
      font-weight: 600;
      margin-bottom: 1.5rem;
    }

    section {
      background: rgba(15, 23, 42, 0.82);
      border-radius: 22px;
      border: 1px solid rgba(148, 163, 184, 0.25);
      padding: 1.6rem;
      box-shadow: 0 30px 60px rgba(15, 23, 42, 0.5);
      display: flex;
      flex-direction: column;
      gap: 1.25rem;
      min-height: 0;
    }

    section h2 {
      margin: 0;
      font-size: 1.45rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th,
    td {
      padding: 0.75rem 0.85rem;
      text-align: left;
      border-bottom: 1px solid rgba(148, 163, 184, 0.18);
      font-size: 0.92rem;
    }

    th {
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 0.78rem;
      color: rgba(148, 163, 184, 0.75);
    }

    tbody tr {
      cursor: pointer;
      transition: background 0.15s ease;
    }

    tbody tr:hover {
      background: rgba(59, 130, 246, 0.12);
    }

    tbody tr.active {
      background: rgba(59, 130, 246, 0.18);
    }

    .controls {
      display: flex;
      gap: 0.75rem;
      align-items: center;
      flex-wrap: wrap;
    }

    button,
    .button-link {
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      color: white;
      border: none;
      border-radius: 999px;
      padding: 0.6rem 1.4rem;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      text-decoration: none;
      box-shadow: 0 14px 32px rgba(37, 99, 235, 0.35);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    button:hover,
    button:focus,
    .button-link:hover,
    .button-link:focus {
      transform: translateY(-2px);
      box-shadow: 0 18px 38px rgba(37, 99, 235, 0.4);
    }

    label.toggle {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
      background: rgba(148, 163, 184, 0.15);
      border-radius: 999px;
      padding: 0.45rem 0.8rem;
    }

    input[type="checkbox"] {
      accent-color: #2563eb;
    }

    .empty-state {
      text-align: center;
      color: rgba(148, 163, 184, 0.7);
      padding: 2rem 1rem;
    }

    .detail-card {
      background: rgba(30, 41, 59, 0.85);
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.2);
      padding: 1.2rem;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .detail-card h3 {
      margin: 0;
      font-size: 1.1rem;
    }

    .key-value {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 0.35rem 0.85rem;
      font-size: 0.93rem;
    }

    .key-value dt {
      color: rgba(148, 163, 184, 0.75);
      font-weight: 500;
    }

    .key-value dd {
      margin: 0;
    }

    pre {
      background: rgba(15, 23, 42, 0.88);
      border-radius: 12px;
      padding: 0.9rem 1rem;
      overflow-x: auto;
      font-family: 'Fira Code', ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      font-size: 0.85rem;
      line-height: 1.55;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.4rem 0.75rem;
      border-radius: 999px;
      font-size: 0.78rem;
      background: rgba(59, 130, 246, 0.18);
      color: rgba(191, 219, 254, 0.9);
    }

    .pill.failed {
      background: rgba(185, 28, 28, 0.25);
      color: rgba(254, 202, 202, 0.9);
    }

    .pill.completed {
      background: rgba(16, 185, 129, 0.25);
      color: rgba(167, 243, 208, 0.9);
    }

    footer {
      text-align: center;
      padding: 2rem 1rem 3rem;
      color: rgba(148, 163, 184, 0.7);
      font-size: 0.95rem;
    }

    @media (max-width: 720px) {
      section {
        padding: 1.4rem;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>MCP Session Observatory</h1>
    <p>Inspect in-flight and historical test sessions. Drill into aggregated analytics, granular action logs, and stored results synchronized with the MCP server.</p>
  </header>

  <main>
    <div>
      <a class="back-link" href="/">← Back to control center</a>

      <section>
        <div class="controls">
          <h2 style="margin:0;flex:1 1 auto;">Sessions</h2>
          <label class="toggle">
            <input type="checkbox" id="auto-refresh" checked />
            Auto-refresh every 10s
          </label>
          <button type="button" id="refresh-sessions">Refresh now</button>
        </div>
        <div style="overflow:auto;">
          <table>
            <thead>
              <tr>
                <th>Session</th>
                <th>URL</th>
                <th>Type</th>
                <th>Status</th>
                <th>Started</th>
              </tr>
            </thead>
            <tbody id="sessions-table">
              <tr><td colspan="5" class="empty-state">Loading sessions…</td></tr>
            </tbody>
          </table>
        </div>
      </section>
    </div>

    <section id="detail-panel">
      <h2>Session details</h2>
      <p style="margin:0;color:rgba(148,163,184,0.75)">Select a session to inspect analytics, logs, and test results.</p>
      <div id="detail-content" class="detail-card" style="display:none"></div>
    </section>
  </main>

  <footer>
    <p>D1-backed telemetry powers the analytics below. Use MCP clients or REST endpoints interchangeably.</p>
  </footer>

  <script>
    const sessionsTable = document.getElementById('sessions-table');
    const detailContent = document.getElementById('detail-content');
    const autoRefreshToggle = document.getElementById('auto-refresh');
    const refreshButton = document.getElementById('refresh-sessions');
    let refreshIntervalId = null;
    let sessionsCache = [];

    refreshButton.addEventListener('click', loadSessions);
    autoRefreshToggle.addEventListener('change', () => {
      if (autoRefreshToggle.checked) {
        startAutoRefresh();
      } else {
        stopAutoRefresh();
      }
    });

    function startAutoRefresh() {
      stopAutoRefresh();
      refreshIntervalId = setInterval(loadSessions, 10000);
    }

    function stopAutoRefresh() {
      if (refreshIntervalId) {
        clearInterval(refreshIntervalId);
        refreshIntervalId = null;
      }
    }

    async function loadSessions() {
      const response = await fetch('/session');
      if (!response.ok) {
        sessionsTable.innerHTML = '<tr><td colspan="5" class="empty-state">Unable to load sessions.</td></tr>';
        return;
      }

      const data = await response.json();
      sessionsCache = data.sessions || [];
      renderSessionTable(sessionsCache);
    }

    function renderSessionTable(sessions) {
      if (!sessions.length) {
        sessionsTable.innerHTML = '<tr><td colspan="5" class="empty-state">No sessions yet. Trigger a test run to see live data.</td></tr>';
        detailContent.style.display = 'none';
        return;
      }

      sessionsTable.innerHTML = sessions.map(session => {
        const statusClass = `pill ${session.status}`;
        return `
          <tr data-session="${session.id}">
            <td><code>${session.id}</code></td>
            <td>${escapeHtml(truncate(session.url, 48))}</td>
            <td>${session.test_type}</td>
            <td><span class="${statusClass}">${session.status}</span></td>
            <td>${session.start_time ? new Date(session.start_time).toLocaleString() : '—'}</td>
          </tr>
        `;
      }).join('');

      sessionsTable.querySelectorAll('tr[data-session]').forEach(row => {
        row.addEventListener('click', () => selectSession(row.dataset.session));
      });
    }

    async function selectSession(sessionId) {
      sessionsTable.querySelectorAll('tr').forEach(row => row.classList.toggle('active', row.dataset.session === sessionId));

      const response = await fetch(`/session?sessionId=${encodeURIComponent(sessionId)}`);
      if (!response.ok) {
        detailContent.style.display = 'block';
        detailContent.innerHTML = `<strong>Failed to load session ${sessionId}</strong>`;
        return;
      }

      const data = await response.json();
      renderSessionDetail(data);
    }

    function renderSessionDetail(data) {
      const { session, results = [], logs = [], stats } = data;
      if (!session) {
        detailContent.style.display = 'block';
        detailContent.innerHTML = '<strong>No session data available.</strong>';
        return;
      }

      const statusClass = `pill ${session.status}`;
      const resultSummary = results.length
        ? results.map(result => `${result.test_name}: ${result.status}${result.error_message ? ` — ${result.error_message}` : ''}`).join('\n')
        : 'No results recorded yet.';

      const logsPreview = logs.slice(-10).map(log => {
        const timestamp = log.timestamp ? new Date(log.timestamp).toLocaleTimeString() : '—';
        return `[${timestamp}] ${log.action_type}${log.error ? ` ⚠️ ${log.error}` : ''}`;
      }).join('\n');

      detailContent.style.display = 'flex';
      detailContent.innerHTML = `
        <h3>Session ${escapeHtml(session.id)}</h3>
        <dl class="key-value">
          <dt>Status</dt><dd><span class="${statusClass}">${session.status}</span></dd>
          <dt>URL</dt><dd>${escapeHtml(session.url)}</dd>
          <dt>Type</dt><dd>${session.test_type}</dd>
          <dt>Started</dt><dd>${session.start_time ? new Date(session.start_time).toLocaleString() : '—'}</dd>
          <dt>Ended</dt><dd>${session.end_time ? new Date(session.end_time).toLocaleString() : '—'}</dd>
          <dt>Config ID</dt><dd>${session.config_id ?? '—'}</dd>
        </dl>
        ${stats ? renderStats(stats) : ''}
        <div>
          <h4 style="margin:0 0 0.4rem 0;">Results</h4>
          <pre>${escapeHtml(resultSummary)}</pre>
        </div>
        <div>
          <h4 style="margin:0 0 0.4rem 0;">Recent logs</h4>
          <pre>${escapeHtml(logsPreview || 'No logs recorded yet.')}</pre>
        </div>
        ${session.error_summary ? `<div class="detail-card" style="background:rgba(185,28,28,0.2);border-color:rgba(248,113,113,0.35);"><strong>Error summary</strong><p style="margin:0">${escapeHtml(session.error_summary)}</p></div>` : ''}
      `;
    }

    function renderStats(stats) {
      const summary = stats.test_results_summary || { passed: 0, failed: 0, skipped: 0 };
      return `
        <div class="detail-card">
          <h3>Analytics</h3>
          <dl class="key-value">
            <dt>Total actions</dt><dd>${stats.total_actions ?? 0}</dd>
            <dt>Total errors</dt><dd>${stats.total_errors ?? 0}</dd>
            <dt>Avg execution time</dt><dd>${stats.avg_execution_time ? Math.round(stats.avg_execution_time) + ' ms' : '—'}</dd>
            <dt>Test summary</dt><dd>✅ ${summary.passed ?? 0} · ❌ ${summary.failed ?? 0} · ⏭️ ${summary.skipped ?? 0}</dd>
          </dl>
        </div>
      `;
    }

    function truncate(value, max) {
      return value.length > max ? value.slice(0, max - 1) + '…' : value;
    }

    function escapeHtml(value) {
      return String(value)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    // Initial load
    loadSessions();
    startAutoRefresh();
  </script>
</body>
</html>
